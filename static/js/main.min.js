const AppState={currentAgent:"",currentUserId:`user_${Date.now()}`,currentSessionId:null,sessions:{},markedConfig:{breaks:!0,gfm:!0}},Utils={formatMessageContent:e=>marked.parse(e),html(e,...t){return e.reduce(((e,s,n)=>{const r=t[n]||"";return e+s+this.escapeHtml(r)}),"")},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},createElementFromHTML(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild},showNotification(e,t="info"){"error"===t?(console.error("[Notification]",e),alert(`Error: ${e}`)):console.log("[Notification]",e)},log(e,...t){console.log(`[${e}]`,...t)},error(e,...t){console.error(`[${e}]`,...t)}},ApiService={async fetchWithError(e,t={}){try{const s=await fetch(e,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return await s.json()}catch(e){throw Utils.error("API",e.message),e}},async listAgents(){return await this.fetchWithError("/api/list-agents")},async loadSessions(e,t){return await this.fetchWithError(`/api/sessions?agent=${e}&user=${t}`)},async createSession(e,t,s){return await this.fetchWithError("/api/create-session",{method:"POST",body:JSON.stringify({agent:e,userId:t,sessionId:s})})},async deleteSession(e,t,s){return await this.fetchWithError("/api/delete-session",{method:"DELETE",body:JSON.stringify({agent:e,userId:t,sessionId:s})})},async sendMessage(e,t,s,n){return await this.fetchWithError("/api/send-message",{method:"POST",body:JSON.stringify({agent:e,userId:t,sessionId:s,message:n})})}},AnalyticsParser={extractAnalyticsData(e){if(!e||!Array.isArray(e))return Utils.log("AnalyticsParser","No full_response or not an array"),null;let t=null;for(let s=0;s<e.length;s++){const n=e[s],r=[n?.actions?.stateDelta?.analytics_output,n?.stateDelta?.analytics_output,n?.analytics_output];for(const e of r)if(null!=e){t=e,Utils.log("AnalyticsParser",`Found analytics_output in event ${s}:`,t);break}if(t)break}return t?this.parseAnalyticsData(t):(Utils.log("AnalyticsParser","No analytics data found in this message"),null)},parseAnalyticsData(e){let t=null;if("object"==typeof e&&null!==e)t=e,Utils.log("AnalyticsParser","Analytics data is already an object");else if("string"==typeof e){const s=/```json([\s\S]*?)```/,n=e.match(s);let r=n?.[1]||e;try{t=JSON.parse(r.trim()),Utils.log("AnalyticsParser","Successfully parsed analytics data as JSON")}catch(e){Utils.error("AnalyticsParser","Failed to parse JSON:",e);try{const e=r.replace(/,(\s*[}\]])/g,"$1").trim();t=JSON.parse(e),Utils.log("AnalyticsParser","Successfully parsed JSON after fixing common issues")}catch(e){Utils.error("AnalyticsParser","Still failed after fixing:",e),t=null}}}else Utils.error("AnalyticsParser","analyticsData is neither object nor string",e);return t}},ChartRenderer={renderAnalysisChart(e,t){Utils.log("ChartRenderer","==== RENDERING CHARTS WITH DATA ===="),Utils.log("ChartRenderer","Full JSON Data:",e),e.analysis_summary&&this.renderTextBlock("Analysis Summary",e.analysis_summary,t),e.insights?.length>0&&this.renderListBlock("Key Insights",e.insights,t),e.visualization_hints?.length>0&&this.renderCharts(e.visualization_hints,t),e.recommendations?.length>0&&this.renderListBlock("Recommendations",e.recommendations,t),t.scrollTop=t.scrollHeight},renderTextBlock(e,t,s){const n=document.createElement("div");n.className="message assistant",n.innerHTML=`\n            <div class="message-content">\n                <strong>${Utils.escapeHtml(e)}:</strong><br>\n                ${Utils.formatMessageContent(t)}\n            </div>\n        `,s.appendChild(n)},renderListBlock(e,t,s){const n=document.createElement("div");n.className="message assistant";const r=t.map((e=>`â€¢ ${Utils.escapeHtml(e)}`)).join("<br>");n.innerHTML=`\n            <div class="message-content">\n                <strong>${Utils.escapeHtml(e)}:</strong><br>\n                ${r}\n            </div>\n        `,s.appendChild(n)},renderCharts(e,t){Utils.log("ChartRenderer",`Rendering ${e.length} charts`),e.forEach(((e,s)=>{Utils.log(`ChartRenderer[${s}]`,"Creating chart:",{type:e.chart_type,title:e.title,x_length:e.x?.length,y_length:e.y?.length});const n=document.createElement("div");n.className="chart-container";const r=`chart-${Date.now()}-${s}`;n.innerHTML=`<div id="${r}" style="width:100%;height:400px;"></div>`,t.appendChild(n),setTimeout((()=>this.renderSingleChart(e,r)),100)}))},renderSingleChart(e,t){const s=document.getElementById(t);if(!s)return void Utils.error("ChartRenderer",`Chart container ${t} not found`);const n=this.createPlotData(e),r=this.createChartLayout(e.title);Utils.log("ChartRenderer","Plotting chart with data:",n),Plotly.newPlot(s,n,r)},createPlotData(e){const t={marker:{color:"#667eea"}};switch(e.chart_type){case"bar":return[{...t,x:e.x,y:e.y,type:"bar"}];case"pie":return[{labels:e.x,values:e.y,type:"pie",marker:{colors:["#667eea","#764ba2","#f093fb","#4facfe"]}}];case"line":return[{...t,x:e.x,y:e.y,type:"scatter",mode:"lines+markers"}];default:return Utils.error("ChartRenderer",`Unknown chart type: ${e.chart_type}`),[]}},createChartLayout:e=>({title:e,font:{family:"Arial, sans-serif"},margin:{t:50,b:50,l:50,r:50},paper_bgcolor:"white",plot_bgcolor:"white"})},UIRenderer={renderSessions(e,t,s){const n=document.getElementById("sessionsContainer"),r=Object.keys(e);0!==r.length?(n.innerHTML=r.map((s=>{const n=e[s];return`\n                <div class="session-item ${s===t?"active":""}" \n                     data-session-id="${Utils.escapeHtml(s)}">\n                    <div class="session-name">\n                        Session ${Utils.escapeHtml(s.substring(0,8))}\n                    </div>\n                    <div class="session-time">\n                        ${new Date(n.created).toLocaleString()}\n                    </div>\n                </div>\n            `})).join(""),n.querySelectorAll(".session-item").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.sessionId;s(t)}))}))):n.innerHTML='\n                <div class="empty-state" style="padding: 20px; text-align: center;">\n                    <p>No sessions yet</p>\n                </div>\n            '},renderMessages(e){const t=document.getElementById("messagesContainer");e&&0!==e.length?(t.innerHTML="",e.forEach(((e,s)=>{Utils.log("UIRenderer",`Processing message ${s}:`,{role:e.role,hasFullResponse:!!e.full_response,timestamp:e.timestamp});const n=document.createElement("div");if(n.className=`message ${e.role}`,n.innerHTML=`\n                <div class="message-content">\n                    ${Utils.formatMessageContent(e.content)}\n                </div>\n                <div class="message-time">\n                    ${new Date(e.timestamp).toLocaleTimeString()}\n                </div>\n            `,t.appendChild(n),"assistant"===e.role&&e.full_response){const s=AnalyticsParser.extractAnalyticsData(e.full_response);s?(Utils.log("UIRenderer","==== JSON DATA FOR CHART RENDERING ===="),Utils.log("UIRenderer",JSON.stringify(s,null,2)),Utils.log("UIRenderer","==== END JSON DATA ===="),ChartRenderer.renderAnalysisChart(s,t)):Utils.log("UIRenderer","No analytics_output found; skipping chart rendering.")}})),t.scrollTop=t.scrollHeight):t.innerHTML='\n                <div class="empty-state">\n                    <div class="empty-state-icon">ðŸ‘‹</div>\n                    <h2>Start chatting!</h2>\n                    <p>Send your first message below</p>\n                </div>\n            '},renderMessage(e,t){const s=document.createElement("div");s.className=`message ${e.role}`,s.innerHTML=`\n            <div class="message-content">\n                ${Utils.formatMessageContent(e.content)}\n            </div>\n            <div class="message-time">\n                ${new Date(e.timestamp).toLocaleTimeString()}\n            </div>\n        `,t.appendChild(s)},updateUIState(e){const t=document.getElementById("messageInput"),s=document.getElementById("sendBtn"),n=document.getElementById("deleteSessionBtn"),r=document.getElementById("chatTitle");e?(t.disabled=!1,s.disabled=!1,n.style.display="block",r.textContent=`${AppState.currentAgent} - Session ${AppState.currentSessionId.substring(0,8)}`):(t.disabled=!0,s.disabled=!0,n.style.display="none",r.textContent=AppState.currentAgent?`${AppState.currentAgent} - Select or create a session`:"Welcome to ADK Chat")}},AppController={async init(){marked.setOptions(AppState.markedConfig),await this.loadAgents(),this.setupEventListeners()},async loadAgents(){try{const e=await ApiService.listAgents(),t=document.getElementById("agentSelector");t.innerHTML='<option value="">Select Agent...</option>',e.forEach((e=>{const s=document.createElement("option");s.value=e,s.textContent=e,t.appendChild(s)}))}catch(e){Utils.showNotification("Failed to load agents","error")}},async loadSessions(){if(AppState.currentAgent)try{AppState.sessions=await ApiService.loadSessions(AppState.currentAgent,AppState.currentUserId),UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this))}catch(e){Utils.showNotification("Failed to load sessions","error")}},async selectSession(e){AppState.currentSessionId=e,UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this)),UIRenderer.updateUIState(!0),AppState.sessions[e]?.messages&&UIRenderer.renderMessages(AppState.sessions[e].messages)},async createNewSession(){if(!AppState.currentAgent)return void Utils.showNotification("Please select an agent first","error");const e=`s_${Date.now()}`;try{await ApiService.createSession(AppState.currentAgent,AppState.currentUserId,e),AppState.sessions[e]={created:(new Date).toISOString(),messages:[]},await this.selectSession(e)}catch(e){Utils.showNotification("Failed to create session","error")}},async deleteCurrentSession(){if(AppState.currentSessionId&&confirm("Delete this session?"))try{await ApiService.deleteSession(AppState.currentAgent,AppState.currentUserId,AppState.currentSessionId),delete AppState.sessions[AppState.currentSessionId],AppState.currentSessionId=null,UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this)),UIRenderer.updateUIState(!1),document.getElementById("messagesContainer").innerHTML='\n                <div class="empty-state">\n                    <div class="empty-state-icon">ðŸ’¬</div>\n                    <h2>Start a conversation</h2>\n                    <p>Select an agent and create a new session to begin</p>\n                </div>\n            '}catch(e){Utils.showNotification("Failed to delete session","error")}},async sendMessage(e){if(!e||!AppState.currentSessionId)return;const t=document.getElementById("messageInput"),s=document.getElementById("sendBtn");s.disabled=!0,s.innerHTML='<span class="loading"></span>',t.disabled=!0;try{AppState.sessions[AppState.currentSessionId].messages.push({role:"user",content:e,timestamp:(new Date).toISOString()}),UIRenderer.renderMessages(AppState.sessions[AppState.currentSessionId].messages),t.value="";const s=await ApiService.sendMessage(AppState.currentAgent,AppState.currentUserId,AppState.currentSessionId,e);"success"===s.status&&s.response?(AppState.sessions[AppState.currentSessionId].messages.push({role:"assistant",content:s.response,full_response:s.full_response,timestamp:(new Date).toISOString()}),UIRenderer.renderMessages(AppState.sessions[AppState.currentSessionId].messages)):Utils.showNotification("Failed to get response from agent","error")}catch(e){Utils.showNotification("Failed to send message","error")}finally{s.disabled=!1,s.textContent="Send",t.disabled=!1,t.focus()}},setupEventListeners(){document.getElementById("messageForm").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("messageInput").value.trim();await this.sendMessage(t)})),document.getElementById("newSessionBtn").addEventListener("click",(()=>{this.createNewSession()})),document.getElementById("deleteSessionBtn").addEventListener("click",(()=>{this.deleteCurrentSession()})),document.getElementById("agentSelector").addEventListener("change",(e=>{AppState.currentAgent=e.target.value,AppState.currentSessionId=null,AppState.sessions={},AppState.currentAgent?this.loadSessions():UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this)),UIRenderer.updateUIState(!1)}))}};document.addEventListener("DOMContentLoaded",(()=>{AppController.init().catch((e=>{console.error("Failed to initialize application:",e)}))}));