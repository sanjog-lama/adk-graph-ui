const AppState={currentAgent:"",currentUserId:"user_1767786285796",currentSessionId:null,sessions:{},markedConfig:{breaks:!0,gfm:!0}},Utils={formatMessageContent:e=>marked.parse(e),html(e,...t){return e.reduce(((e,s,n)=>{const a=t[n]||"";return e+s+this.escapeHtml(a)}),"")},escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML},createElementFromHTML(e){const t=document.createElement("template");return t.innerHTML=e.trim(),t.content.firstChild},showNotification(e,t="info"){"error"===t?(console.error("[Notification]",e),alert(`Error: ${e}`)):console.log("[Notification]",e)},log(e,...t){console.log(`[${e}]`,...t)},error(e,...t){console.error(`[${e}]`,...t)}},ApiService={async fetchWithError(e,t={}){try{const s=await fetch(e,{...t,headers:{"Content-Type":"application/json",...t.headers}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);return await s.json()}catch(e){throw Utils.error("API",e.message),e}},async listAgents(){return await this.fetchWithError("/api/list-agents")},async loadSessions(e,t){return await this.fetchWithError(`/api/sessions?agent=${e}&user=${t}`)},async createSession(e,t,s){return await this.fetchWithError("/api/create-session",{method:"POST",body:JSON.stringify({agent:e,userId:t,sessionId:s})})},async deleteSession(e,t,s){return await this.fetchWithError("/api/delete-session",{method:"DELETE",body:JSON.stringify({agent:e,userId:t,sessionId:s})})},async sendMessage(e,t,s,n){return await this.fetchWithError("/api/send-message",{method:"POST",body:JSON.stringify({agent:e,userId:t,sessionId:s,message:n})})},async sendMessageStreaming(e,t,s,n,a){const{onEvent:r,onComplete:i,onError:o}=a;try{const a=await fetch("/api/send-message-sse",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({agent:e,userId:t,sessionId:s,message:n})});if(!a.ok)throw new Error(`HTTP ${a.status}: ${a.statusText}`);const l=a.body.getReader(),c=new TextDecoder;let d="";for(;;){const{done:e,value:t}=await l.read();if(e){Utils.log("SSE","Stream completed"),i&&i();break}d+=c.decode(t,{stream:!0});const s=d.split("\n");d=s.pop();for(const e of s)if(e.startsWith("data: ")){const t=e.slice(6).trim();if(""===t)continue;try{const e=JSON.parse(t);if("error"===e.type){Utils.error("SSE","Error event:",e.message),o&&o(new Error(e.message));break}if("complete"===e.type){Utils.log("SSE","Received completion event"),i&&i();break}r&&r(e)}catch(e){Utils.error("SSE","Failed to parse event:",e,t)}}}}catch(e){throw Utils.error("SSE","Streaming error:",e),o&&o(e),e}}},AnalyticsParser={extractAnalyticsData(e){if(e&&Array.isArray(e))for(const t of e){const e=[t?.actions?.stateDelta?.analytics_output,t?.stateDelta?.analytics_output,t?.analytics_output];for(const t of e)if(null!=t)return Utils.log("AnalyticsParser","Found analytics_output in full_response:",t),this.parseAnalyticsData(t)}return"string"==typeof e?(Utils.log("AnalyticsParser","Attempting to extract from content string"),this.extractFromContentString(e)):(Utils.log("AnalyticsParser","No analytics_output found"),null)},extractFromContentString(e){const t=[...e.matchAll(/```json\s*([\s\S]*?)\s*```/g)];for(const e of t)try{const t=JSON.parse(e[1].trim());if(this.isAnalyticsData(t))return Utils.log("AnalyticsParser","Extracted analytics from fenced JSON"),t}catch(e){}try{const t=e.match(/\{[\s\S]*\}$/);if(t){const e=JSON.parse(t[0]);if(this.isAnalyticsData(e))return Utils.log("AnalyticsParser","Extracted analytics from raw JSON"),e}}catch(e){Utils.error("AnalyticsParser","Raw JSON parse failed",e)}return null},isAnalyticsData:e=>e&&"object"==typeof e&&(e.hasOwnProperty("visualization_hints")||e.hasOwnProperty("analysis_summary")||e.hasOwnProperty("insights")||e.hasOwnProperty("recommendations")),parseAnalyticsData(e){let t=null;if("object"==typeof e&&null!==e)t=e,Utils.log("AnalyticsParser","Analytics data is already an object");else if("string"==typeof e){const s=/```json([\s\S]*?)```/,n=e.match(s);let a=n?.[1]||e;try{t=JSON.parse(a.trim()),Utils.log("AnalyticsParser","Successfully parsed analytics data as JSON")}catch(e){Utils.error("AnalyticsParser","Failed to parse JSON:",e);try{const e=a.replace(/,(\s*[}\]])/g,"$1").trim();t=JSON.parse(e),Utils.log("AnalyticsParser","Successfully parsed JSON after fixing common issues")}catch(e){Utils.error("AnalyticsParser","Still failed after fixing:",e),t=null}}}else Utils.error("AnalyticsParser","analyticsData is neither object nor string",e);return t}},ChartRenderer={renderAnalysisChart(e,t){Utils.log("ChartRenderer","==== RENDERING CHARTS WITH DATA ===="),Utils.log("ChartRenderer","Full JSON Data:",e),e.analysis_summary&&this.renderTextBlock("Analysis Summary",e.analysis_summary,t),e.insights?.length>0&&this.renderListBlock("Key Insights",e.insights,t),e.visualization_hints?.length>0&&this.renderCharts(e.visualization_hints,t),e.recommendations?.length>0&&this.renderListBlock("Recommendations",e.recommendations,t),t.scrollTop=t.scrollHeight},renderTextBlock(e,t,s){const n=document.createElement("div");n.className="message assistant",n.innerHTML=`\n            <div class="message-content">\n                <strong>${Utils.escapeHtml(e)}:</strong><br>\n                ${Utils.formatMessageContent(t)}\n            </div>\n        `,s.appendChild(n)},renderListBlock(e,t,s){const n=document.createElement("div");n.className="message assistant";const a=t.map((e=>`â€¢ ${Utils.escapeHtml(e)}`)).join("<br>");n.innerHTML=`\n            <div class="message-content">\n                <strong>${Utils.escapeHtml(e)}:</strong><br>\n                ${a}\n            </div>\n        `,s.appendChild(n)},renderCharts(e,t){const s=Date.now();e.forEach(((e,n)=>{Utils.log(`ChartRenderer[${n}]`,"Creating chart:",e);const a=document.createElement("div");a.className="chart-container";const r=`chart-${s}-${n}`;a.innerHTML=`<div id="${r}" style="width:100%;height:400px;"></div>`,t.appendChild(a),setTimeout((()=>this.renderSingleChart(e,r)),50)}))},renderSingleChart(e,t){const s=document.getElementById(t);if(!s)return void Utils.error("ChartRenderer",`Chart container ${t} not found`);const n=this.createPlotData(e),a=this.createChartLayout(e.title);Plotly.newPlot(s,n,a)},createPlotData(e){const t={marker:{color:"#667eea"}};switch(e.chart_type){case"bar":return[{...t,x:e.x,y:e.y,type:"bar"}];case"pie":return[{labels:e.x,values:e.y,type:"pie",marker:{colors:["#667eea","#764ba2","#f093fb","#4facfe"]}}];case"line":return[{...t,x:e.x,y:e.y,type:"scatter",mode:"lines+markers"}];default:return Utils.error("ChartRenderer",`Unknown chart type: ${e.chart_type}`),[]}},createChartLayout:e=>({title:e,font:{family:"Arial, sans-serif"},margin:{t:50,b:50,l:50,r:50},paper_bgcolor:"white",plot_bgcolor:"white"})},UIRenderer={renderSessions(e,t,s){const n=document.getElementById("sessionsContainer"),a=Object.keys(e);0!==a.length?(n.innerHTML=a.map((s=>{const n=e[s];return`\n                <div class="session-item ${s===t?"active":""}" \n                     data-session-id="${Utils.escapeHtml(s)}">\n                    <div class="session-name">Session ${Utils.escapeHtml(s.substring(0,8))}</div>\n                    <div class="session-time">${new Date(n.created).toLocaleString()}</div>\n                </div>\n            `})).join(""),n.querySelectorAll(".session-item").forEach((e=>{e.addEventListener("click",(()=>{const t=e.dataset.sessionId;s(t)}))}))):n.innerHTML='<div class="empty-state" style="padding: 20px; text-align: center;">\n                <p>No sessions yet</p>\n            </div>'},renderMessages(e){const t=document.getElementById("messagesContainer");t.innerHTML="",e&&0!==e.length?(e.forEach(((e,s)=>{if(Utils.log("UIRenderer",`Processing message ${s}:`,e),"assistant"===e.role){let n=null;if(e.full_response&&(n=AnalyticsParser.extractAnalyticsData(e.full_response)),!n&&e.content&&(n=AnalyticsParser.extractFromContentString(e.content)),n)Utils.log("UIRenderer","Rendering charts for message",s),ChartRenderer.renderAnalysisChart(n,t);else{const s=document.createElement("div");s.className=`message ${e.role}`,s.innerHTML=`\n                        <div class="message-content">${Utils.formatMessageContent(e.content)}</div>\n                        <div class="message-time">${new Date(e.timestamp).toLocaleTimeString()}</div>\n                    `,t.appendChild(s)}}else{const s=document.createElement("div");s.className=`message ${e.role}`,s.innerHTML=`\n                    <div class="message-content">${Utils.formatMessageContent(e.content)}</div>\n                    <div class="message-time">${new Date(e.timestamp).toLocaleTimeString()}</div>\n                `,t.appendChild(s)}})),t.scrollTop=t.scrollHeight):t.innerHTML='\n                <div class="empty-state">\n                    <div class="empty-state-icon">ðŸ‘‹</div>\n                    <h2>Start chatting!</h2>\n                    <p>Send your first message below</p>\n                </div>\n            '},renderMessage(e,t){const s=document.createElement("div");s.className=`message ${e.role}`,s.innerHTML=`\n            <div class="message-content">${Utils.formatMessageContent(e.content)}</div>\n            <div class="message-time">${new Date(e.timestamp).toLocaleTimeString()}</div>\n        `,t.appendChild(s)},updateUIState(e){const t=document.getElementById("messageInput"),s=document.getElementById("sendBtn"),n=document.getElementById("deleteSessionBtn"),a=document.getElementById("chatTitle");e?(t.disabled=!1,s.disabled=!1,n.style.display="block",a.textContent=`${AppState.currentAgent} - Session ${AppState.currentSessionId.substring(0,8)}`):(t.disabled=!0,s.disabled=!0,n.style.display="none",a.textContent=AppState.currentAgent?`${AppState.currentAgent} - Select or create a session`:"Welcome to ADK Chat")}},AppController={async init(){marked.setOptions(AppState.markedConfig),await this.loadAgents(),this.setupEventListeners()},async loadAgents(){try{const e=await ApiService.listAgents(),t=document.getElementById("agentSelector");t.innerHTML='<option value="">Select Agent...</option>',e.forEach((e=>{const s=document.createElement("option");s.value=e,s.textContent=e,t.appendChild(s)}))}catch{Utils.showNotification("Failed to load agents","error")}},async loadSessions(){if(AppState.currentAgent)try{AppState.sessions=await ApiService.loadSessions(AppState.currentAgent,AppState.currentUserId),UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this))}catch{Utils.showNotification("Failed to load sessions","error")}},async selectSession(e){AppState.currentSessionId=e,UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this)),UIRenderer.updateUIState(!0);try{const t=await ApiService.fetchWithError(`/api/session/${e}?agent=${AppState.currentAgent}&user=${AppState.currentUserId}`);AppState.sessions[e]={...AppState.sessions[e],messages:t.messages||[]},UIRenderer.renderMessages(AppState.sessions[e].messages)}catch{Utils.showNotification("Failed to load session messages","error")}},async createNewSession(){if(!AppState.currentAgent)return void Utils.showNotification("Please select an agent first","error");const e=`s_${Date.now()}`;try{await ApiService.createSession(AppState.currentAgent,AppState.currentUserId,e),AppState.sessions[e]={created:(new Date).toISOString(),messages:[]},await this.selectSession(e)}catch{Utils.showNotification("Failed to create session","error")}},async deleteCurrentSession(){if(AppState.currentSessionId&&confirm("Delete this session?"))try{await ApiService.deleteSession(AppState.currentAgent,AppState.currentUserId,AppState.currentSessionId),delete AppState.sessions[AppState.currentSessionId],AppState.currentSessionId=null,UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this)),UIRenderer.updateUIState(!1),document.getElementById("messagesContainer").innerHTML='\n                <div class="empty-state">\n                    <div class="empty-state-icon">ðŸ’¬</div>\n                    <h2>Start a conversation</h2>\n                    <p>Select an agent and create a new session to begin</p>\n                </div>\n            '}catch{Utils.showNotification("Failed to delete session","error")}},async sendMessage(e){if(!e||!AppState.currentSessionId)return;const t=document.getElementById("messageInput"),s=document.getElementById("sendBtn"),n=document.getElementById("messagesContainer");s.disabled=!0,s.innerHTML='<span class="loading"></span>',t.disabled=!0;const a={role:"user",content:e,timestamp:(new Date).toISOString()};AppState.sessions[AppState.currentSessionId].messages.push(a);const r=document.createElement("div");r.className="message user",r.innerHTML=`\n            <div class="message-content">${Utils.formatMessageContent(e)}</div>\n            <div class="message-time">${(new Date).toLocaleTimeString()}</div>\n        `,n.appendChild(r),t.value="",n.scrollTop=n.scrollHeight;let i=null,o="",l=[];try{await ApiService.sendMessageStreaming(AppState.currentAgent,AppState.currentUserId,AppState.currentSessionId,e,{onEvent:e=>{Utils.log("SSE Event",e),l.push(e);const t=e.content?.parts;if(t&&Array.isArray(t))for(const e of t){if(e.text){i||(i=document.createElement("div"),i.className="message assistant",i.innerHTML=`\n                                            <div class="message-content"></div>\n                                            <div class="message-time">${(new Date).toLocaleTimeString()}</div>\n                                        `,n.appendChild(i),o=""),o+=e.text;i.querySelector(".message-content").innerHTML=Utils.formatMessageContent(o),n.scrollTop=n.scrollHeight}e.functionCall&&(Utils.log("Tool Call",`Calling ${e.functionCall.name}`),o.trim()&&(i=null,o="")),e.functionResponse&&(Utils.log("Tool Result",`${e.functionResponse.name} completed`),i=null,o="")}},onComplete:()=>{Utils.log("SSE","Stream completed");const e={role:"assistant",content:o,full_response:l,timestamp:(new Date).toISOString()};AppState.sessions[AppState.currentSessionId].messages.push(e);let a=AnalyticsParser.extractAnalyticsData(l);if(!a&&o&&(a=AnalyticsParser.extractFromContentString(o)),a){n.querySelectorAll(".message.assistant").forEach((e=>e.remove())),ChartRenderer.renderAnalysisChart(a,n)}s.disabled=!1,s.textContent="Send",t.disabled=!1,t.focus()},onError:e=>{Utils.showNotification("Failed to get streaming response","error");const a=document.createElement("div");a.className="message assistant error-message",a.innerHTML=`\n                            <div class="message-content">\n                                <span style="color: red;">Error: Failed to get response</span>\n                            </div>\n                            <div class="message-time">${(new Date).toLocaleTimeString()}</div>\n                        `,n.appendChild(a),s.disabled=!1,s.textContent="Send",t.disabled=!1}})}catch(e){Utils.showNotification("Failed to send message","error"),s.disabled=!1,s.textContent="Send",t.disabled=!1,t.focus()}},setupEventListeners(){document.getElementById("messageForm").addEventListener("submit",(async e=>{e.preventDefault();const t=document.getElementById("messageInput").value.trim();await this.sendMessage(t)})),document.getElementById("newSessionBtn").addEventListener("click",(()=>this.createNewSession())),document.getElementById("deleteSessionBtn").addEventListener("click",(()=>this.deleteCurrentSession())),document.getElementById("agentSelector").addEventListener("change",(async e=>{AppState.currentAgent=e.target.value,AppState.currentSessionId=null,AppState.sessions={},AppState.currentAgent?await this.loadSessions():UIRenderer.renderSessions(AppState.sessions,AppState.currentSessionId,this.selectSession.bind(this)),UIRenderer.updateUIState(!1)}))}};document.addEventListener("DOMContentLoaded",(()=>{AppController.init().catch((e=>{console.error("Failed to initialize application:",e)}))}));